<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Barcode Uploader</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col justify-center items-center min-h-screen p-4">

    <div class="bg-white p-8 md:p-12 rounded-lg shadow-xl w-full max-w-xl text-center">
        <h1 class="text-3xl font-bold text-blue-700 mb-6">Upload PDF Files with Barcodes</h1>

        <form id="uploadForm" action="{% url 'upload_pdf' %}" method="POST" enctype="multipart/form-data" class="flex flex-col gap-4 mb-6">
            {% csrf_token %}
            <label class="block">
                <span class="sr-only">Choose files</span>
                <input type="file" name="pdf_files" multiple accept=".pdf" required
                       class="block w-full text-sm text-gray-500
                              file:mr-4 file:py-2 file:px-4
                              file:rounded-full file:border-0
                              file:text-sm file:font-semibold
                              file:bg-blue-50 file:text-blue-700
                              hover:file:bg-blue-100"/>
            </label>
            <input type="text" name="user_name" placeholder="Your Name" required
                   class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <button type="submit"
                    class="py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200">
                Upload Files
            </button>
        </form>

        <div id="status" class="mt-4 text-lg text-gray-600"></div>
        <div class="w-full bg-gray-200 rounded-full h-8 overflow-hidden mt-4">
            <div id="progressBar" class="bg-green-500 h-full text-center text-white text-sm leading-8" style="width: 0%;"></div>
        </div>
        <div id="results" class="mt-8"></div>
    </div>
    
    <script>
        document.getElementById('uploadForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const fileInput = form.querySelector('input[type="file"]');
            const totalFiles = fileInput.files.length;
            const statusDiv = document.getElementById('status');
            const progressBar = document.getElementById('progressBar');
            const resultsDiv = document.getElementById('results');

            resultsDiv.innerHTML = '';
            progressBar.style.width = '0%';
            statusDiv.textContent = `Processing 0 of ${totalFiles} files...`;

            fetch(form.action, {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                progressBar.style.width = '100%';
                statusDiv.textContent = `Processing complete. Processed ${data.total_files} files.`;

                let html = '<h2 class="text-xl font-semibold text-gray-700 mb-4">Uploaded Files Results:</h2>';
                html += '<div class="overflow-x-auto"><table class="min-w-full bg-white rounded-lg shadow-md">';
                html += '<thead class="bg-blue-600 text-white"><tr><th class="py-3 px-4 text-left">Filename</th><th class="py-3 px-4 text-left">Barcode Values</th><th class="py-3 px-4 text-left">Status</th></tr></thead>';
                html += '<tbody>';
                data.results.forEach(result => {
                    const barcodeValue = Array.isArray(result.barcodes_found) && result.barcodes_found.length > 0
                        ? result.barcodes_found.join(', ')
                        : 'N/A';
                    const statusText = result.status;
                    let statusClass = '';
                    if (statusText.includes('Success')) {
                        statusClass = 'text-green-600 font-bold';
                    } else if (statusText.includes('Duplicate')) {
                        statusClass = 'text-yellow-600 font-bold';
                    } else {
                        statusClass = 'text-red-600 font-bold';
                    }

                    html += `<tr class="border-t border-gray-200"><td class="py-3 px-4">${result.filename}</td><td class="py-3 px-4">${barcodeValue}</td><td class="py-3 px-4 ${statusClass}">${statusText}</td></tr>`;
                });
                html += '</tbody></table></div>';
                resultsDiv.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                statusDiv.textContent = 'An error occurred during upload. Please check the console for details.';
            });
        });
    </script>
</body>
</html>