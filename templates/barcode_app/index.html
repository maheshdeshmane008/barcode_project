{% extends 'include/base.html' %}
{% load static %}
{% block title %}Barcode App{% endblock %}
{% block content %}
<style>
   /* Base container for the progress bar */
/* Progress Bar Container */
.progress-bar-top {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px; /* A thin line */
    background-color: #e0e0e0; /* Light gray background */
    z-index: 1000; /* Ensure it's on top of other content */
}

/* The animated inner bar */
.progress-bar-top-inner {
    height: 100%;
    background-color: #4285F4; /* A prominent blue, like Google's */
    width: 100%;
    animation: indeterminate-progress 2s linear infinite;
    transform-origin: 0% 50%;
}

/* Keyframe animation for the progress bar */
@keyframes indeterminate-progress {
    0% {
        transform: scaleX(0.0) translateX(0);
    }
    40% {
        transform: scaleX(0.4) translateX(0);
    }
    100% {
        transform: scaleX(0.4) translateX(250%);
    }
}

/* Utility class to show/hide the bar */
.hidden {
    display: none;
}
</style>
<div class="page-body">
    
    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-12">
          <div class="card">
            <div class="card-body">
              <div class="form theme-form">
                <form id="uploadForm" action="{% url 'upload_pdf' %}" method="POST" enctype="multipart/form-data">
                  {% csrf_token %}
                <div class="row">
                
                 
                  <div class="col-sm-4">
                    <div class="mb-3">
                      <label><i class="fa fa-chevron-right" aria-hidden="true"></i>Choose files <span class="imp">*</span></label>
                      <input type="file" name="pdf_files" multiple accept=".pdf" required  class="form-control" value="{{ upload_path }}">
                    </div>
                  </div>

                  <div class="col-sm-4">
                    <div class="mb-3">
                        <label>Expected File Location:</label>
                        <input type="text" class="form-control" value="{{ upload_path }}" readonly>
                    </div>
                </div>
                 
                </div>
                {% if permissions.can_insert %}
                <div class="row">
                  <div class="col">
                    <div class="text-end"><a class="btn btn-success me-3 add" href="#" id="add">Upload Files</a><a class="btn btn-danger" href="#">Cancel</a></div>
                  </div>
                </div>
                {% endif %}
                <div id="status" class="mt-4 text-lg text-gray-600"></div>
                <div class="row">
                    <div id="topProgressBar" class="progress-bar-top hidden">
                        <div class="progress-bar-top-inner"></div>
                      </div>
                </div>
       
              </form>
              </div>
            </div>
            <div class="card-body">
                <div class="table-responsive custom-scrollbar">
                    <table class="display" id="basic-1">
                      <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Barcode Values</th>
                            <th>Status</th>
                        </tr>
                      </thead >
                     <tbody id="results"></tbody>
                    </table>
                  </div>
              </div>
          </div>
        
        </div>
      </div>
    </div>
    </div>
    <script>
      $(document).ready(function() {
          $("#add").on("click", function(event) {
              event.preventDefault(); 
              
              const form = $("#uploadForm")[0];
              const formData = new FormData(form);
              const statusDiv = $("#status");
              const topProgressBar = $("#topProgressBar");
              const resultsDiv = $("#results");
              
              const csrfToken = $('[name=csrfmiddlewaretoken]').val();
              
              // Show the progress bar and clear previous results
              topProgressBar.removeClass('hidden');
              resultsDiv.html('');
              statusDiv.text(`Uploading files...`);
              
              $.ajax({
                  url: form.action,
                  type: 'POST',
                  data: formData,
                  processData: false, 
                  contentType: false, 
                  headers: {
                      'X-CSRFToken': csrfToken
                  },
                  success: function(data) {
                      // Hide the progress bar on success
                      topProgressBar.addClass('hidden');
                      statusDiv.text(`Processing complete. Processed ${data.total_files} file(s).`);
                      
                      let html = '';
                      let hasError = false;
                      
                      data.results.forEach(result => {
                          const barcodeValue = Array.isArray(result.barcodes_found) && result.barcodes_found.length > 0
                              ? result.barcodes_found.join(', ')
                              : 'N/A';
                          const statusText = result.status;
                          let statusClass = 'badge rounded-pill';
                          
                          if (statusText.includes('Success')) {
                              statusClass += ' badge-success';
                          } else if (statusText.includes('Duplicate')) {
                              statusClass += ' badge-warning';
                              hasError = true;
                          } else {
                              statusClass += ' badge-danger';
                              hasError = true;
                          }
                          
                          html += `<tr ><td>${result.filename}</td><td >${barcodeValue}</td><td ><span class="${statusClass}">${statusText}</span></td></tr>`;
                      });
                      
                      resultsDiv.html(html);
                  },
                  error: function(jqXHR, textStatus, errorThrown) {
                      // Hide the progress bar on error
                      topProgressBar.addClass('hidden');
                      
                      // Check for the specific 403 Forbidden status code
                      if (jqXHR.status === 403) {
                          try {
                              const errorData = JSON.parse(jqXHR.responseText);
                              statusDiv.text(errorData.message);
                              statusDiv.addClass('text-danger'); // Add a class for styling
                          } catch (e) {
                              statusDiv.text('An unknown permission error occurred.');
                              statusDiv.addClass('text-danger');
                          }
                      } else {
                          // Handle other types of errors
                          console.error('Error:', textStatus, errorThrown, jqXHR.responseText);
                          statusDiv.text('An unexpected error occurred during upload.');
                          statusDiv.addClass('text-danger');
                      }
                  }
              });
          });
      });
  </script>
 {% endblock %}
    
    
                

