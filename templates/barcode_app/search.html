{% extends 'include/base.html' %}
{% load static %}
{% block title %}Barcode App{% endblock %}
{% block content %}
<style>
  .text-blue-600 {
    color: black;
    font-weight: 600;
  }
  .text-yellow-600 {
    color: yellow;
    font-weight: 600;
  }
  .text-gray-400 {
    color: green;
    font-weight: 600;
  }
  .hidden {
    display: none;
  }
</style>
<div class="page-body">
    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-12">
          <div class="card">
            <div class="card-body">
              <div class="form theme-form">
                {% csrf_token %}
                <div class="row">         
                  <div class="col-sm-12">
                    <div class="mb-3">
                      <label><i class="fa fa-chevron-right" aria-hidden="true"></i>Search Barcode <span class="imp">*</span></label>
                      <input type="text" id="barcodeInput" placeholder="Scan or type barcode number here..."
                   class="form-control" autofocus/>
                    </div>
                  </div>
                </div>
                
                <div class="row">
                    <div id="resultsSection" class="hidden">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Search Results</h2>
                        <div id="fileTableContainer" class="overflow-x-auto mb-8">
                        </div>
                        <div id="statusMessage" class="hidden text-center text-gray-600 mb-4"></div>
                        {% if permissions.can_insert %} 
                        <div class="flex items-center gap-4" id="actionButtons" style="margin-top:15px;">
                            <button id="printSelected" class="btn btn-success me-3">
                                Print Selected Files
                            </button>
                            <button id="markSelectedAsPrinted" class="btn btn-warning me-3">
                                Mark Selected as Printed
                            </button>
                        </div>
                        {% endif %}
                    </div>
            
                    <div id="noResults" class="hidden text-center text-gray-600">
                        <p>No results found for this barcode.</p>
                    </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
</div>
<script>
    const barcodeInput = document.getElementById('barcodeInput');
    const resultsSection = document.getElementById('resultsSection');
    const fileTableContainer = document.getElementById('fileTableContainer');
    const actionButtons = document.getElementById('actionButtons');
    const printSelectedButton = document.getElementById('printSelected');
    const markSelectedAsPrintedButton = document.getElementById('markSelectedAsPrinted');
    const noResultsDiv = document.getElementById('noResults');
    const statusMessageDiv = document.getElementById('statusMessage');

    // Flag to track if the page has unsaved data
    let hasDataOnPage = false;

    // Event listener for the beforeunload event
    window.addEventListener('beforeunload', function(e) {
      if (hasDataOnPage) {
        // Cancel the event and trigger the browser's generic confirmation dialog
        e.preventDefault();
        e.returnValue = '';
      }
    });

    function fetchResults() {
        const barcodeValue = barcodeInput.value.trim();
        if (barcodeValue === '') {
            resultsSection.classList.add('hidden');
            noResultsDiv.classList.add('hidden');
            hasDataOnPage = false; // No data on the page
            return;
        }

        const barcodes = [barcodeValue];

        statusMessageDiv.textContent = 'Searching...';
        statusMessageDiv.classList.remove('hidden');
        resultsSection.classList.remove('hidden');
        noResultsDiv.classList.add('hidden');
        
        fetch('{% url "search-barcode" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 'barcodes': barcodes })
        })
        .then(response => response.json())
        .then(data => {
            statusMessageDiv.classList.add('hidden');

            if (data.success && data.labels.length > 0) {
                const existingTableBody = fileTableContainer.querySelector('tbody');
                const newLabels = data.labels.filter(label => {
                    return !fileTableContainer.querySelector(`tr[data-label-id="${label.id}"]`);
                });

                if (newLabels.length > 0) {
                    let rowsHtml = newLabels.map(label => `
                        <tr  data-label-id="${label.id}">
                            <td class="text-center">
                                <input type="checkbox" name="label_id" value="${label.id}">
                            </td>
                             <td >${label.location_name}</td>
                            <td ><a href="/shippinglabel/get-label/${label.id}/" target="_blank">
                    ${label.file_name}
                </a></td>
                            <td >${label.user}</td>
                            <td >
                                <span class="badge rounded-pill ${label.status === 1 ? 'badge-success' : 'badge-danger'}">
                                    ${label.status === 1 ? 'Success' : 'Failed'}
                                </span>
                            </td>
                            <td >
                                <ul class="list-disc list-inside">
                                    ${label.barcodes.map(b => `<li>${b}</li>`).join('')}
                                </ul>
                            </td>
                            <td >
                                <span class="font-bold print-status-span ${label.print_download_status === 0 ? 'text-blue-600' : label.print_download_status === 1 ? 'text-gray-400' : 'text-yellow-600'}">
                                    ${label.print_download_status === 0 ? 'New' : label.print_download_status === 1 ? 'Printed' : 'Sent for Printing'}
                                </span>
                            </td>
                        </tr>
                    `).join('');

                    if (existingTableBody) {
                        existingTableBody.innerHTML += rowsHtml;
                    } else {
                        const tableHtml = `
                        <div class="table-responsive signal-table custom-scrollbar">
                            <table class="table table-hover">
                                <thead >
                                    <tr>
                                        <th >
                                            <input type="checkbox" id="selectAll">
                                        </th>
                                         <th>Location</th>
                                        <th>File Name</th>
                                        <th>User</th>
                                        <th>Status</th>
                                        <th>Scanned Barcodes</th>
                                        <th>Print Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rowsHtml}
                                </tbody>
                            </table>
                            </div>
                        `;
                        fileTableContainer.innerHTML = tableHtml;
                    }
                    actionButtons.classList.remove('hidden');
                    attachEventListeners();
                    hasDataOnPage = true; // Set flag to true as we now have results
                } else {
                    statusMessageDiv.textContent = `Barcode "${barcodeValue}" is already in the list.`;
                }
            } else {
                statusMessageDiv.textContent = `No results found for "${barcodeValue}".`;
                hasDataOnPage = false; // No results, so no data to lose
            }

            barcodeInput.value = '';
            barcodeInput.focus();
        })
        .catch(error => {
            console.error('Error:', error);
            statusMessageDiv.textContent = 'An error occurred. Please try again.';
            hasDataOnPage = false; // An error occurred, no data to lose
            barcodeInput.value = '';
            barcodeInput.focus();
        });
    }
    
    let typingTimer;
    const doneTypingInterval = 500;

    barcodeInput.addEventListener('keyup', (event) => {
        clearTimeout(typingTimer);
        if (event.key === 'Enter') {
            fetchResults();
        } else {
            typingTimer = setTimeout(fetchResults, doneTypingInterval);
        }
    });

    function getSelectedIds() {
        const checkboxes = document.querySelectorAll('input[name="label_id"]:checked');
        return Array.from(checkboxes).map(cb => cb.value);
    }

    function attachEventListeners() {
        const selectAllCheckbox = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('input[name="label_id"]');

        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', (e) => {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });
        }

        // Restore the full print functionality
        printSelectedButton.addEventListener('click', () => {
            const selectedIds = getSelectedIds();
            if (selectedIds.length === 0) {
                alert('Please select at least one file to print.');
                return;
            }

            printSelectedButton.textContent = 'Processing...';
            printSelectedButton.disabled = true;
           
            fetch(' {% url "print-labels" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ 'ids': selectedIds })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            })
            .then(blob => {
                const pdfUrl = URL.createObjectURL(blob);
                window.open(pdfUrl, '_blank');
                URL.revokeObjectURL(pdfUrl);

                selectedIds.forEach(id => {
                    const row = document.querySelector(`tr[data-label-id="${id}"]`);
                    if (row) {
                        const statusCell = row.querySelector('td:nth-child(6) span');
                        if (statusCell) {
                            statusCell.textContent = 'Sent for Printing';
                            statusCell.className = 'font-bold print-status-span text-yellow-600';
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error during print process:', error);
                alert('An error occurred during printing. Please check the console for details and try again.');
            })
            .finally(() => {
                printSelectedButton.textContent = 'Print Selected Files';
                printSelectedButton.disabled = false;
            });
        });

        // Restore the full 'Mark as Printed' functionality
        markSelectedAsPrintedButton.addEventListener('click', () => {
            const selectedIds = getSelectedIds();
            if (selectedIds.length === 0) {
                alert('Please select at least one file to mark as printed.');
                return;
            }

            const confirmation = confirm('Are you sure you want to mark these labels as printed?');
            if (confirmation) {
                markSelectedAsPrintedButton.textContent = 'Updating...';
                markSelectedAsPrintedButton.disabled = true;
                
                fetch('{% url "update-selected-print-status" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ 'ids': selectedIds })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating status. Please try again.');
                })
                .finally(() => {
                    markSelectedAsPrintedButton.textContent = 'Mark Selected as Printed';
                    markSelectedAsPrintedButton.disabled = false;
                });
            }
        });
    }
</script>
{% endblock %}